<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BloomFlowers</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1 class="logo">BloomFlowers</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button id="profileBtn" class="btn">Profile</button>
                <button id="wishlistBtn" class="btn">Wishlist</button>
                <button id="cartBtn" class="btn">Cart <span id="cartCount">0</span></button>
                <button id="trackOrderBtn" class="btn">Track Order</button>
                <button id="logoutBtn" class="btn">Logout</button>
            </div>
        </div>
    </header>

    <main>
        <section class="dashboard">
            <div class="container">
                <h2>User Dashboard</h2>
                
                <div class="user-info">
                    <h3>Profile Information</h3>
                    <p><strong>Username:</strong> <span id="userUsername"></span></p>
                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>Account Type:</strong> <span id="userRole"></span></p>
                </div>
                
                <div class="user-orders">
                    <div class="orders-header">
                        <h3>Order History</h3>
                        <button id="refreshOrders" class="btn btn-outline">Refresh</button>
                    </div>
                    <div id="orderHistory">
                        <!-- Order history will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 BloomFlowers. All rights reserved.</p>
        </div>
    </footer>

    <script src="utils.js"></script>
    <!-- Include the API script -->
    <script src="backend/api.js"></script>
    <script>
        // Check if user is logged in
        function checkLoginStatus() {
            const user = localStorage.getItem('currentUser');
            
            if (!user) {
                // Redirect to home page if not logged in
                window.location.href = 'index.html';
                return;
            }
            
            const userData = JSON.parse(user);
            
            // Display user information
            document.getElementById('userUsername').textContent = userData.username;
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('userRole').textContent = 'Customer';
            
            // Update cart count
            updateCartCount();
            
            // Add event listeners for buttons
            document.getElementById('profileBtn').addEventListener('click', () => {
                window.location.href = 'profile.html';
            });
            
            document.getElementById('wishlistBtn').addEventListener('click', () => {
                window.location.href = 'wishlist.html';
            });
            
            document.getElementById('cartBtn').addEventListener('click', () => {
                window.location.href = 'cart.html';
            });
            
            document.getElementById('trackOrderBtn').addEventListener('click', () => {
                window.location.href = 'track-order.html';
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Add event listener for refresh button
            document.getElementById('refreshOrders').addEventListener('click', loadOrderHistory);
            
            // Load order history
            loadOrderHistory();
        }
        
        // Load order history
        function loadOrderHistory() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            const orderHistory = document.getElementById('orderHistory');
            
            // Show loading message
            orderHistory.innerHTML = '<p>Loading order history...</p>';
            
            // Fetch orders from backend API
            fetch(`http://localhost:3000/api/orders/user/${user.id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch order history');
                }
                return response.json();
            })
            .then(orders => {
                if (orders.length === 0) {
                    orderHistory.innerHTML = '<p>You have no order history yet.</p>';
                    return;
                }
                
                let ordersHtml = '';
                orders.forEach(order => {
                    // Parse shipping address if it's a string
                    let shippingAddress = order.shippingAddress;
                    if (typeof shippingAddress === 'string') {
                        try {
                            shippingAddress = JSON.parse(shippingAddress);
                        } catch (e) {
                            shippingAddress = {};
                        }
                    }
                    
                    // Create items HTML
                    let itemsHtml = '';
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(item => {
                            // Use a flower icon instead of images
                            const flowerIcon = getFlowerIcon(item.category || "default");
                            itemsHtml += `
                                <div class="order-item-mini">
                                    <i class="${flowerIcon}" style="margin-right: 5px; color: #e91e63;"></i>
                                    ${item.productName} (x${item.quantity}) - ₹${(item.price * item.quantity * 83).toFixed(2)}
                                </div>
                            `;
                        });
                    } else {
                        itemsHtml = '<div class="order-item-mini">Order items (view details in order confirmation)</div>';
                    }
                    
                    // Determine currency symbol (now using INR)
                    const currencySymbol = '₹';
                    
                    // Format order date
                    const orderDate = new Date(order.orderDate);
                    const formattedOrderDate = orderDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    ordersHtml += `
                        <div class="order-card">
                            <div class="order-header">
                                <div>Order #${order.id}</div>
                                <div class="order-date">${formattedOrderDate}</div>
                            </div>
                            <div class="order-items-mini">
                                ${itemsHtml}
                            </div>
                            <div class="order-payment">
                                <div class="payment-method">Payment: Completed</div>
                                <div class="currency">INR</div>
                            </div>
                            <div class="order-tracking">
                                <div class="tracking-number">Status: ${order.status}</div>
                                <div class="delivery-date">Total: ${currencySymbol}${parseFloat(order.totalAmount * 83).toFixed(2)}</div>
                            </div>
                            <div class="order-footer">
                                <div class="order-status ${order.status.toLowerCase().replace(' ', '-')}">${order.status}</div>
                            </div>
                            <div class="order-actions">
                                <button class="btn btn-outline" onclick="viewOrderDetails('${order.id}')">View Details</button>
                            </div>
                        </div>
                    `;
                });
                
                orderHistory.innerHTML = ordersHtml;
            })
            .catch(error => {
                console.error('Error loading order history:', error);
                orderHistory.innerHTML = '<p>Error loading order history. Please try again later.</p>';
            });
        }
        
        // View order details
        function viewOrderDetails(orderId) {
            // Redirect to order details page
            window.location.href = `track-order.html?orderId=${orderId}`;
        }
        
        // Function to get appropriate flower icon based on category
        function getFlowerIcon(category) {
            const iconMap = {
                "Rose": "fas fa-rose",
                "Tulip": "fas fa-seedling",
                "Sunflower": "fas fa-sun",
                "Lily": "fas fa-feather-alt",
                "Orchid": "fas fa-wind",
                "Daisy": "fas fa-leaf",
                "Carnation": "fas fa-pagelines",
                "Peony": "fas fa-spa",
                "Hydrangea": "fas fa-cloud",
                "Daffodil": "fas fa-star",
                "Chrysanthemum": "fas fa-asterisk",
                "Poppy": "fas fa-apple-alt",
                "Lavender": "fas fa-air-freshener",
                "Jasmine": "fas fa-moon",
                "Gardenia": "fas fa-circle",
                "Camellia": "fas fa-dot-circle",
                "Azalea": "fas fa-ring",
                "Begonia": "fas fa-heart",
                "Marigold": "fas fa-fire",
                "Zinnia": "fas fa-splotch",
                "Cosmos": "fas fa-meteor",
                "Snapdragon": "fas fa-sort-up",
                "Foxglove": "fas fa-hand-point-up",
                "Delphinium": "fas fa-water",
                "Lisianthus": "fas fa-mountain",
                "Freesia": "fas fa-wind",
                "Gladiolus": "fas fa-sword",
                "Alstroemeria": "fas fa-archway",
                "Statice": "fas fa-anchor",
                "Limonium": "fas fa-lemon",
                "Eucalyptus": "fas fa-tree",
                "Ranunculus": "fas fa-radiation",
                "Anemone": "fas fa-wind",
                "Sweet Pea": "fas fa-peapod",
                "Stock": "fas fa-align-center",
                "Celosia": "fas fa-feather",
                "Buddleia": "fas fa-bug",
                "Heather": "fas fa-mound",
                "Protea": "fas fa-egg",
                "Bird of Paradise": "fas fa-dove",
                "Calla Lily": "fas fa-shoe-prints",
                "Gerbera Daisy": "fas fa-dizzy",
                "Cherry Blossom": "fas fa-chess-pawn",
                "Magnolia": "fas fa-medal",
                "Hibiscus": "fas fa-hockey-puck",
                "default": "fas fa-seedling"
            };
            
            // Return specific icon or default
            return iconMap[category] || iconMap.default;
        }
        
        // Run when DOM is loaded
        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>