<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - BloomFlowers</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1 class="logo">BloomFlowers</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button id="logoutBtn" class="btn">Logout</button>
            </div>
        </div>
    </header>

    <main>
        <section class="checkout-page">
            <div class="container">
                <h2>Checkout</h2>
                <div class="checkout-content">
                    <div class="checkout-form">
                        <h3>Billing Information</h3>
                        <form id="billingForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" required>
                                </div>
                                <div class="form-group">
                                    <label for="zipCode">ZIP Code</label>
                                    <input type="text" id="zipCode" required>
                                </div>
                            </div>
                            
                            <h3>Payment Method</h3>
                            <div class="form-group">
                                <label for="currency">Currency</label>
                                <select id="currency" class="form-control">
                                    <option value="INR">INR (₹)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Payment Options</label>
                                <div class="payment-options">
                                    <div class="payment-option">
                                        <input type="radio" id="phonepe" name="paymentMethod" value="PhonePe" checked>
                                        <label for="phonepe">PhonePe</label>
                                    </div>
                                    <div class="payment-option">
                                        <input type="radio" id="gpay" name="paymentMethod" value="GPay">
                                        <label for="gpay">Google Pay (GPay)</label>
                                    </div>
                                    <div class="payment-option">
                                        <input type="radio" id="netbanking" name="paymentMethod" value="NetBanking">
                                        <label for="netbanking">Net Banking</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="paymentDetails">
                                <!-- Payment details will be shown based on selection -->
                            </div>
                        </form>
                    </div>
                    
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="summary-items" id="summaryItems">
                            <!-- Order items will be loaded here dynamically -->
                        </div>
                        <div class="summary-item">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Shipping:</span>
                            <span id="shipping">₹496.87</span>
                        </div>
                        <div class="summary-item">
                            <span>Tax:</span>
                            <span id="tax">₹0.00</span>
                        </div>
                        <div class="summary-item total">
                            <span>Total:</span>
                            <span id="total">₹0.00</span>
                        </div>
                        <button id="placeOrderBtn" class="btn btn-primary">Place Order</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 BloomFlowers. All rights reserved.</p>
        </div>
    </footer>

    <script src="utils.js"></script>
    <!-- Include the API script -->
    <script src="backend/api.js"></script>
    <script>
        // Check if user is logged in
        function checkLoginStatus() {
            console.log('Checking login status');
            const user = localStorage.getItem('currentUser');
            
            console.log('Current user:', user);
            
            if (!user) {
                // Redirect to home page if not logged in
                console.log('User not logged in, redirecting to index.html');
                window.location.href = 'index.html';
                return;
            }
            
            // Add event listeners
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Add event listener for currency change
            document.getElementById('currency').addEventListener('change', function() {
                loadOrderSummary();
            });
            
            // Add event listeners for payment method selection
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', showPaymentDetails);
            });
            
            // Load order summary
            loadOrderSummary();
            showPaymentDetails();
        }
        
        // Show payment details based on selection
        function showPaymentDetails() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const paymentDetails = document.getElementById('paymentDetails');
            
            switch(selectedMethod) {
                case 'PhonePe':
                    paymentDetails.innerHTML = `
                        <div class="form-group">
                            <label for="phonepeNumber">PhonePe Number</label>
                            <input type="text" id="phonepeNumber" placeholder="Enter your PhonePe registered number">
                        </div>
                    `;
                    break;
                case 'GPay':
                    paymentDetails.innerHTML = `
                        <div class="form-group">
                            <label for="upiId">UPI ID</label>
                            <input type="text" id="upiId" placeholder="Enter your UPI ID (e.g., username@upi)">
                        </div>
                    `;
                    break;
                case 'NetBanking':
                    paymentDetails.innerHTML = `
                        <div class="form-group">
                            <label for="bank">Select Bank</label>
                            <select id="bank" class="form-control">
                                <option value="">Select your bank</option>
                                <option value="sbi">State Bank of India</option>
                                <option value="hdfc">HDFC Bank</option>
                                <option value="icici">ICICI Bank</option>
                                <option value="axis">Axis Bank</option>
                                <option value="kotak">Kotak Mahindra Bank</option>
                            </select>
                        </div>
                    `;
                    break;
            }
        }
        
        // Load order summary
        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const summaryItems = document.getElementById('summaryItems');
            const currency = document.getElementById('currency').value;
            
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }
            
            summaryItems.innerHTML = '';
            
            let subtotal = 0;
            
            cart.forEach(item => {
                // Prices are already in INR, no conversion needed
                const price = parseFloat(item.price);
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <span>${item.name} (x${item.quantity})</span>
                    <span>₹${itemTotal.toFixed(2)}</span>
                `;
                summaryItems.appendChild(summaryItem);
            });
            
            // Shipping cost is already in INR
            const shipping = 496.87;
            
            const tax = subtotal * 0.08; // 8% tax
            const total = subtotal + tax + shipping;
            
            updateSummary(subtotal, tax, total, currency, shipping);
        }
        
        // Update order summary
        function updateSummary(subtotal, tax, total, currency, shipping) {
            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('shipping').textContent = `₹${shipping.toFixed(2)}`;
            document.getElementById('tax').textContent = `₹${tax.toFixed(2)}`;
            document.getElementById('total').textContent = `₹${total.toFixed(2)}`;
        }
        
        // Place order
        function placeOrder() {
            console.log('Place order function called');
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const zipCode = document.getElementById('zipCode').value;
            const currency = document.getElementById('currency').value;
            const currencySymbol = '₹';
            
            console.log('Form data:', { firstName, lastName, email, address, city, zipCode });
            
            if (!firstName || !lastName || !email || !address || !city || !zipCode) {
                alert('Please fill in all billing information');
                return;
            }
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // Validate payment details based on method
            let paymentValid = true;
            let paymentDetails = '';
            
            switch(paymentMethod) {
                case 'PhonePe':
                    const phonepeNumber = document.getElementById('phonepeNumber').value;
                    if (!phonepeNumber) {
                        alert('Please enter your PhonePe number');
                        paymentValid = false;
                    } else {
                        paymentDetails = `PhonePe: ${phonepeNumber}`;
                    }
                    break;
                case 'GPay':
                    const upiId = document.getElementById('upiId').value;
                    if (!upiId) {
                        alert('Please enter your UPI ID');
                        paymentValid = false;
                    } else {
                        paymentDetails = `UPI ID: ${upiId}`;
                    }
                    break;
                case 'NetBanking':
                    const bank = document.getElementById('bank').value;
                    if (!bank) {
                        alert('Please select your bank');
                        paymentValid = false;
                    } else {
                        const bankNames = {
                            'sbi': 'State Bank of India',
                            'hdfc': 'HDFC Bank',
                            'icici': 'ICICI Bank',
                            'axis': 'Axis Bank',
                            'kotak': 'Kotak Mahindra Bank'
                        };
                        paymentDetails = `Bank: ${bankNames[bank]}`;
                    }
                    break;
            }
            
            if (!paymentValid) {
                return;
            }
            
            // Get current user and cart
            const userStr = localStorage.getItem('currentUser');
            const cartStr = localStorage.getItem('cart');
            
            console.log('User data:', userStr);
            console.log('Cart data:', cartStr);
            
            if (!userStr) {
                alert('User not logged in. Please log in to place an order.');
                return;
            }
            
            const user = JSON.parse(userStr);
            const cart = JSON.parse(cartStr) || [];
            
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items to your cart before placing an order.');
                return;
            }
            
            console.log('Parsed user:', user);
            console.log('Parsed cart:', cart);
            
            // Calculate total
            const totalText = document.getElementById('total').textContent;
            const total = parseFloat(totalText.replace('₹', '').trim());
            
            // Calculate estimated delivery date (3-5 business days from today)
            const deliveryDate = calculateDeliveryDate();
            
            // Prepare order data for API
            const orderData = {
                userId: user.id,
                userName: `${user.firstName} ${user.lastName}`,
                userEmail: user.email,
                products: cart.map(item => ({
                    productId: item.id,
                    productName: item.name,
                    quantity: parseInt(item.quantity),
                    price: parseFloat(item.price)
                })),
                totalAmount: parseFloat(total),
                shippingAddress: {
                    firstName: firstName,
                    lastName: lastName,
                    address: address,
                    city: city,
                    zipCode: zipCode
                }
            };
            
            console.log('Sending order data to backend:', orderData);
            
            // Send order to backend API
            fetch('http://localhost:3000/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to place order');
                    });
                }
                return response.json();
            })
            .then(order => {
                // Clear cart
                localStorage.removeItem('cart');
                
                // Save order details for confirmation page
                localStorage.setItem('lastOrder', JSON.stringify({
                    id: order.id || order.orderReference,
                    userId: user.id,
                    items: cart,
                    total: `${currencySymbol}${parseFloat(total).toFixed(2)}`,
                    currency: currency,
                    paymentMethod: paymentMethod,
                    paymentDetails: paymentDetails,
                    shippingAddress: {
                        firstName: firstName,
                        lastName: lastName,
                        address: address,
                        city: city,
                        zipCode: zipCode
                    },
                    date: new Date(order.orderDate || new Date()).toLocaleString(),
                    status: order.status || 'processing',
                    deliveryDate: deliveryDate
                }));
                
                // Redirect to order confirmation
                window.location.href = 'order-confirmation.html';
            })
            .catch(error => {
                console.error('Error placing order:', error);
                alert(`Failed to place order: ${error.message}. Please try again.`);
            });
        }
        
        // Run when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            checkLoginStatus();
            
            // Add event listener for place order button
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            console.log('Place order button element:', placeOrderBtn);
            
            if (placeOrderBtn) {
                placeOrderBtn.addEventListener('click', function(e) {
                    console.log('Place order button clicked');
                    e.preventDefault(); // Prevent any default form submission
                    placeOrder();
                });
                console.log('Event listener added to place order button');
            } else {
                console.error('Place order button not found');
            }
        });
    </script>
</body>
</html>