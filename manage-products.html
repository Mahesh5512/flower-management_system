<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - BloomFlowers</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <h1 class="logo">BloomFlowers</h1>
            <nav>
                <ul>
                    <li><a href="admin-dashboard.html">Dashboard</a></li>
                    <li><a href="manage-products.html" class="active">Products</a></li>
                    <li><a href="manage-orders.html">Orders</a></li>
                    <li><a href="manage-users.html">Users</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button id="logoutBtn" class="btn">Logout</button>
            </div>
        </div>
    </header>

    <main>
        <section class="manage-products">
            <div class="container">
                <div class="page-header">
                    <h2>Product Management</h2>
                    <button id="addProductBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add New Product
                    </button>
                </div>

                <!-- Add/Edit Product Form -->
                <div id="productFormContainer" class="product-form-container" style="display: none;">
                    <div class="form-card">
                        <h3 id="formTitle">Add New Product</h3>
                        <form id="productForm">
                            <input type="hidden" id="productId">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productName">Product Name</label>
                                    <input type="text" id="productName" placeholder="Enter product name" required>
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">Price ($)</label>
                                    <input type="number" id="productPrice" placeholder="Enter price" step="0.01" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="productDescription">Description</label>
                                <textarea id="productDescription" placeholder="Enter product description" rows="3" required></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productCategory">Category</label>
                                    <select id="productCategory" required>
                                        <option value="">Select a category</option>
                                        <option value="Rose">Rose</option>
                                        <option value="Tulip">Tulip</option>
                                        <option value="Sunflower">Sunflower</option>
                                        <option value="Lily">Lily</option>
                                        <option value="Orchid">Orchid</option>
                                        <option value="Daisy">Daisy</option>
                                        <option value="Carnation">Carnation</option>
                                        <option value="Peony">Peony</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productEmoji">Emoji Representation</label>
                                    <select id="productEmoji" required>
                                        <option value="">Select an emoji</option>
                                        <option value="üåπ">üåπ Rose</option>
                                        <option value="üå∑">üå∑ Tulip</option>
                                        <option value="üåª">üåª Sunflower</option>
                                        <option value="ÁôæÂêà">ÁôæÂêà Lily</option>
                                        <option value="üå∏">üå∏ Cherry Blossom</option>
                                        <option value="üå∫">üå∫ Hibiscus</option>
                                        <option value="üåº">üåº Blossom</option>
                                        <option value="üíê">üíê Bouquet</option>
                                        <option value="ü•Ä">ü•Ä Wilted</option>
                                        <option value="ü™∑">ü™∑ Lotus</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="cancelBtn" class="btn btn-outline">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Product</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Products List -->
                <div class="products-list">
                    <h3>Current Products</h3>
                    <div class="product-grid" id="adminProductGrid">
                        <!-- Products will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 BloomFlowers. All rights reserved.</p>
        </div>
    </footer>

    <!-- Include the API script -->
    <script src="backend/api.js"></script>
    <script>
        // Check if admin is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            const adminLoggedIn = localStorage.getItem('adminLoggedIn');
            
            // Check if user is logged in and has admin role
            if (!currentUser || !adminLoggedIn) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            const userData = JSON.parse(currentUser);
            if (userData.role !== 'admin') {
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Initialize the page
            loadProducts();
            
            // Add event listeners
            document.getElementById('addProductBtn').addEventListener('click', showAddProductForm);
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            document.getElementById('cancelBtn').addEventListener('click', hideProductForm);
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('adminLoggedIn');
                window.location.href = 'index.html';
            });
        });
        
        // Load products for admin view
        function loadProducts() {
            const productGrid = document.getElementById('adminProductGrid');
            
            // Show loading message
            productGrid.innerHTML = '<p>Loading products...</p>';
            
            // Fetch products from backend API
            fetch('http://localhost:3000/api/products')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }
                return response.json();
            })
            .then(flowers => {
                productGrid.innerHTML = '';
                
                if (flowers.length === 0) {
                    productGrid.innerHTML = '<p>No products found. Add your first product!</p>';
                    return;
                }
                
                flowers.forEach(flower => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card admin-product-card';
                    productCard.innerHTML = `
                        <div class="product-image">${flower.image}</div>
                        <div class="product-info">
                            <h3>${flower.name}</h3>
                            <p>${flower.description}</p>
                            <div class="price">$${parseFloat(flower.price).toFixed(2)}</div>
                            <div class="product-actions">
                                <button class="btn btn-primary" onclick="window.location.href='product-detail.html?id=${flower.id}'">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-outline" onclick="editProduct(${flower.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduct(${flower.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(productCard);
                });
            })
            .catch(error => {
                console.error('Error loading products:', error);
                productGrid.innerHTML = '<p>Error loading products. Please try again later.</p>';
            });
        }
        
        // Show add product form
        function showAddProductForm() {
            document.getElementById('formTitle').textContent = 'Add New Product';
            document.getElementById('productId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productEmoji').value = '';
            document.getElementById('productFormContainer').style.display = 'block';
        }
        
        // Hide product form
        function hideProductForm() {
            document.getElementById('productFormContainer').style.display = 'none';
        }
        
        // Edit product
        function editProduct(productId) {
            // Fetch product details from backend API
            fetch(`http://localhost:3000/api/products/${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch product');
                }
                return response.json();
            })
            .then(flower => {
                document.getElementById('formTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = flower.id;
                document.getElementById('productName').value = flower.name;
                document.getElementById('productPrice').value = flower.price;
                document.getElementById('productDescription').value = flower.description;
                document.getElementById('productCategory').value = flower.category;
                document.getElementById('productEmoji').value = flower.image;
                document.getElementById('productFormContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching product:', error);
                alert('Error fetching product details. Please try again.');
            });
        }
        
        // Delete product
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                // Delete product via backend API
                fetch(`http://localhost:3000/api/products/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete product');
                    }
                    return response.json();
                })
                .then(result => {
                    loadProducts(); // Reload products list
                    alert('Product deleted successfully!');
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product. Please try again.');
                });
            }
        }
        
        // Handle product form submission
        function handleProductSubmit(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const description = document.getElementById('productDescription').value;
            const category = document.getElementById('productCategory').value;
            const image = document.getElementById('productEmoji').value;
            
            // Prepare product data for API
            const productData = {
                name: name,
                price: parseFloat(price),
                description: description,
                category: category,
                image: image
            };
            
            if (productId) {
                // Update existing product
                fetch(`http://localhost:3000/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update product');
                    }
                    return response.json();
                })
                .then(updatedProduct => {
                    hideProductForm();
                    loadProducts();
                    alert('Product updated successfully!');
                })
                .catch(error => {
                    console.error('Error updating product:', error);
                    alert('Error updating product. Please try again.');
                });
            } else {
                // Add new product
                fetch('http://localhost:3000/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to add product');
                    }
                    return response.json();
                })
                .then(newProduct => {
                    hideProductForm();
                    loadProducts();
                    alert('Product added successfully!');
                })
                .catch(error => {
                    console.error('Error adding product:', error);
                    alert('Error adding product. Please try again.');
                });
            }
        }
    </script>
</body>
</html>